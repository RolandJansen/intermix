<html>

<head>
    <title>Sequencer Demo</title>
    <style>
        html {
            font-family: Arial, Helvetica, sans-serif;

        }

        .button-group div {
            /* float: left; */
            display: inline-block;
        }

        #blink {
            width: 20px;
            height: 20px;
            border-style: solid;
        }
    </style>
</head>

<body onload="init();">
    <button id="resumeAudioContext">resume audio context</button>
    <button id="getstate">get current state</button>
    <div id="sequencer"></div>
    <div class="button-group">
        <div id="start-button"></div>
        <div id="pause-button"></div>
        <div id="stop-button"></div>
        <div id="set-bpm"></div>
    </div>
    <!-- <div id="blink"></div> -->
</body>
<script>

    const sequencer = new Nexus.Sequencer('#sequencer', {
        size: [540, 200],
        rows: 4,
        columns: 16,
    })
    const startButton = new Nexus.TextButton('#start-button', {
        text: 'Start',
    })
    const pauseButton = new Nexus.TextButton('#pause-button', {
        text: 'Pause',
    })
    const stopButton = new Nexus.TextButton('#stop-button', {
        text: 'Stop',
    })
    const setBpm = new Nexus.Number('#set-bpm', {
        size: [80, 50],
        value: 120,
        min: 0,
        max: 240,
    })

    startButton.on('change', () => {
        sequencer.stepper.value = -1;
        seqActionCreators.STATE(1);
    })

    pauseButton.on('change', () => {
        seqActionCreators.STATE(2);
    })

    stopButton.on('change', () => {

        seqActionCreators.STATE(0);
        // sequencer.stepper.value = -1;
        // const counter = new Nexus.Counter(0, 1);
        // counter.value = 0;
        // sequencer.stepper(counter);
    })

    sequencer.on('change', (e) => {
        // console.log(e);
        const partId = seqPartUID[e.row];
        const samplerId = samplerUID[e.row];
        const actionCreators = intermix.getActionCreators(partId);
        const action = getNote(40, 1, samplerId);
        if (e.state) {
            // send an "ADD_ACTION" action with a note as payload to the according part
            actionCreators.ADD_ACTION({
                step: e.column,
                action,
            });
        } else {
            // send a "REMOVE_ACTION" action with the exact position to the according part
            actionCreators.REMOVE_ACTION({
                step: e.column,
                action,
            })
        }
    })

    const selectNextSeqRow = (step) => {
        if (step % 4 === 0) {
            sequencer.next();
        }
    }

    const ac = intermix.getAudioContext();
    const samplerUID = [];
    const seqPartUID = [];
    let sequencerUID = '';

    let synthUID = "";
    let seqActionCreators = {};
    let samplerActionCreators = {};

    let samples = [
        demo.skkick,
        demo.sksnare,
        demo.skclhat,
        demo.skophat,
    ]

    function init() {

        // create sampler plugins and a sequencer part for each one
        for (let i = 0; i < 4; i++) {
            samplerUID.push(intermix.addPlugin('DemoSampler'))
            seqPartUID.push(intermix.addSeqPart())  // 16 steps if not stated otherwise
        }

        console.log(samplerUID)

        // add a sample to each sampler
        samples.forEach((sample, index) => {
            addAudioDataToSampler(samplerUID[index], sample["default"]);
        })

        // setup the sequencer
        sequencerUID = intermix.addPlugin('Sequencer');
        seqActionCreators = intermix.getActionCreators(sequencerUID);
        seqActionCreators.ANIMATE(selectNextSeqRow);  // animate the sequencer

        // setup a basic sequence
        sequencer.matrix.populate.row(0, [1, 0, 0, 0, 0, 0, 0, 0]);
        sequencer.matrix.populate.row(1, [0, 0, 0, 0, 1, 0, 0, 0]);
        sequencer.matrix.populate.row(2, [0, 0, 1, 0]);

        // add notes to the seqParts
        populateSeqParts(sequencer.matrix.pattern);

        // add parts to sequencer and to the score
        seqPartUID.forEach((seqPartId, index) => {
            const part = intermix.getSeqPart(seqPartId);
            seqActionCreators.ADD_PART(part);
            seqActionCreators.ADD_TO_SCORE({
                partID: seqPartId,
                position: 0,
            })
        })

        // play in loop mode
        seqActionCreators.LOOP_ACTIVE(true);

    }

    const loadFile = (url) => {
        return window.fetch(url)
            .then((response) => {
                if (response.ok) {
                    return response.arrayBuffer();
                } else {
                    throw new Error('Server error. Couldn\'t load file: ' + url);
                }
            });
    };

    const addAudioDataToSampler = (samplerUID, rawData) => {
        loadFile(rawData).then((response) => {
            return ac.decodeAudioData(response);
        }).then((decoded) => {
            const audioDataAction = {
                type: "AUDIODATA",
                dest: samplerUID,
                payload: decoded,
            };
            // send the audio buffer to the sampler
            const actionCreators = intermix.getActionCreators(samplerUID)
            actionCreators.AUDIODATA(audioDataAction)
        })
    }

    const populateSeqParts = (matrix) => {
        matrix.forEach((seqRow, rowIndex) => {
            const seqPartId = seqPartUID[rowIndex];
            const samplerId = samplerUID[rowIndex];
            const seqPartActionCreators = intermix.getActionCreators(seqPartId);
            const note = getNote(40, 1, samplerId);

            seqRow.forEach((seqStep, stepIndex) => {
                if (seqRow[stepIndex] === true) {
                    seqPartActionCreators.ADD_ACTION({
                        step: stepIndex,
                        action: note,
                    });
                }
            })
        })
    }

    const getNote = (value, steps, uid) => {
        const velocity = 1;
        const duration = 0;
        return {
            type: "NOTE",
            dest: uid,
            payload: {
                value,
                velocity,
                steps,
                duration,
            }
        }
    }

    document.getElementById('resumeAudioContext').addEventListener('click', () => {
        intermix.resumeAudioContext();
        console.log("Audio Context Resumed");
    });

    document.getElementById("getstate").addEventListener('click', () => {
        console.log(intermix.getState());
    })

    // const ac = intermix.getAudioContext();
    // const synthPart1 = intermix.getNewPart();
    // const synthPart2 = intermix.getNewPart();
    // const hhatPart = intermix.getNewPart();

    // function init() {

    //     // const testNote = getNote(64, 4, samplerUID);
    //     // samplerActionCreators["NOTE"](testNote);

    //     // make a part and add it to the sequencer
    //     const note1 = getNote(32, 4, synthUID);
    //     const note2 = getNote(33, 4, synthUID);
    //     const note3 = getNote(44, 4, synthUID);
    //     const note4 = getNote(33, 8, synthUID);

    //     console.log(samplerUID);
    //     const hhNote = getNote(40, 8, samplerUID);

    //     synthPart1.addAction(note1, 0)
    //         .addAction(note1, 1)
    //         .addAction(note1, 2)
    //         .addAction(note1, 3)
    //         .addAction(note2, 4)
    //         .addAction(note3, 5)
    //         .addAction(note1, 6)
    //         .addAction(note1, 7)
    //         .addAction(note1, 8)
    //         .addAction(note1, 9)
    //         .addAction(note1, 10)
    //         .addAction(note1, 11)
    //         .addAction(note2, 12)
    //         .addAction(note3, 13)
    //         .addAction(note4, 14);

    //     hhatPart.addAction(hhNote, 0)
    //         .addAction(hhNote, 4)
    //         .addAction(hhNote, 8)
    //         .addAction(hhNote, 12);

    //     seqActionCreators["ADD_PART"]({ part: synthPart1, position: 0 });
    //     seqActionCreators["ADD_PART"]({ part: hhatPart, position: 0 });
    //     seqActionCreators["LOOP_ACTIVE"](true);

    // }


</script>

</html>