<html>

<head>
    <title>Sequencer Demo</title>
    <style>
        html {
            font-family: Arial, Helvetica, sans-serif;

        }

        .button-group div {
            /* float: left; */
            display: inline-block;
        }

        #blink {
            width: 20px;
            height: 20px;
            border-style: solid;
        }
    </style>
</head>

<body onload="init();">
    <button id="resumeAudioContext">resume audio context</button>
    <button id="getstate">get current state</button>
    <div id="sequencer"></div>
    <div class="button-group">
        <div id="start-button"></div>
        <div id="stop-button"></div>
        <div id="reset-button"></div>
        <div id="set-bpm"></div>
    </div>
    <!-- <div id="blink"></div> -->
</body>
<script>

    let BPM = 120;

    const sequencer = new Nexus.Sequencer('#sequencer', {
        size: [540, 200],
        rows: 4,
        columns: 16,
    })
    const startButton = new Nexus.TextButton('#start-button', {
        text: 'Start',
    })
    const stopButton = new Nexus.TextButton('#stop-button', {
        text: 'Stop',
    })
    const resetButton = new Nexus.TextButton('#reset-button', {
        text: 'Reset',
    })
    const setBpm = new Nexus.Number('#set-bpm', {
        size: [80, 50],
        value: BPM,
        min: 0,
        max: 240,
    })

    startButton.on('change', (e) => {
        // e: true -> mousedown
        if (e) {
            sequencer.stepper.value = -1;
            seqActionCreators.start();
        }
    })

    stopButton.on('change', (e) => {
        // e: true -> mousedown
        if (e) {
            seqActionCreators.stop();
        }
    })

    resetButton.on('change', (e) => {
        // e: true -> mousedown
        if (e) {
            seqActionCreators.reset();
            // sequencer.stepper.value = -1;
            // const counter = new Nexus.Counter(0, 1);
            // counter.value = 0;
            // sequencer.stepper(counter);
        }
    })

    setBpm.on('change', (e) => {
        // e: true -> mousedown
        if (e) {
            BPM = e;
            seqActionCreators.BPM(e);
        }
    })

    sequencer.on('change', (e) => {
        const partId = seqPartUID[e.row];
        const instrumentId = instrumentUID[e.row];
        const partActionCreators = intermix.getActionCreators(partId);
        const duration = get16thDuration(BPM);
        if (e.state) {
            // send an "addNote" action to the according part
            partActionCreators.activeStep(e.column);
            partActionCreators.addNote(["note", 40, 1, duration, 0.0]);
        } else {
            // send a "deleteNote" action to the according part
            partActionCreators.activeStep(e.column);
            partActionCreators.removeNote(["note", 40, 1, duration, 0.0]);
        }
    })

    const selectNextSeqRow = (step) => {
        if (step % 4 === 0) {
            sequencer.next();
        }
    }

    const ac = intermix.getAudioContext();
    const instrumentUID = [];
    const seqPartUID = [];
    let sequencerUID = '';

    let synthUID = "";
    let seqActionCreators = {};
    let samplerActionCreators = {};

    let samples = [
        demo.skkick,
        demo.sksnare,
        demo.skclhat,
        demo.skophat,
    ]

    function init() {

        // create sampler plugins and a sequencer part for each one
        for (let i = 0; i < 4; i++) {
            instrumentUID.push(intermix.addPlugin('Sampler'))
            seqPartUID.push(intermix.addSeqPart())  // 16 steps if not stated otherwise
        }

        // add a sample to each sampler
        samples.forEach((sample, index) => {
            addAudioDataToSampler(instrumentUID[index], sample["default"]);
        })

        // setup the sequencer
        sequencerUID = intermix.addPlugin('Sequencer');
        seqActionCreators = intermix.getActionCreators(sequencerUID);
        seqActionCreators.animate(selectNextSeqRow);  // animate the sequencer

        console.log(seqActionCreators);

        // setup a basic sequence
        sequencer.matrix.populate.row(0, [1, 0, 0, 0, 0, 0, 0, 0]);
        sequencer.matrix.populate.row(1, [0, 0, 0, 0, 1, 0, 0, 0]);
        sequencer.matrix.populate.row(2, [0, 0, 1, 0]);

        // add notes to the seqParts
        // populateSeqParts(sequencer.matrix.pattern);

        // add parts to sequencer and to the score
        seqPartUID.forEach((seqPartId, index) => {
            const part = intermix.getSeqPart(seqPartId);
            // seqActionCreators.ADD_PART(part);
            seqActionCreators.addToScore([seqPartId, instrumentUID[index]])
        })

        // play in loop mode
        // seqActionCreators.loopActive();
        seqActionCreators.loopActivate();

    }

    const loadFile = (url) => {
        return window.fetch(url)
            .then((response) => {
                if (response.ok) {
                    return response.arrayBuffer();
                } else {
                    throw new Error('Server error. Couldn\'t load file: ' + url);
                }
            });
    };

    const addAudioDataToSampler = (samplerUID, rawData) => {
        loadFile(rawData).then((response) => {
            return ac.decodeAudioData(response);
        }).then((decoded) => {
            // send the audio buffer to the sampler
            const actionCreators = intermix.getActionCreators(samplerUID)
            actionCreators.audioData(decoded)
        })
    }

    const populateSeqParts = (matrix) => {
        matrix.forEach((seqRow, rowIndex) => {
            const seqPartId = seqPartUID[rowIndex];
            const samplerId = instrumentUID[rowIndex];
            const seqPartActionCreators = intermix.getActionCreators(seqPartId);
            // const duration = get16thDuration()

            seqRow.forEach((seqStep, stepIndex) => {
                if (seqRow[stepIndex] === true) {
                    seqPartActionCreators.addNote(["note", 40, 1, 1.0, 0.0]);
                }
            })
        })
    }

    const get16thDuration = (bpm) => {
        const divisor = bpm * 4;
        return timePerBeat = 60 / divisor;
    }

    document.getElementById('resumeAudioContext').addEventListener('click', () => {
        intermix.resumeAudioContext();
        console.log("Audio Context Resumed");
    });

    document.getElementById("getstate").addEventListener('click', () => {
        console.log(intermix.getState());
    })

    // const ac = intermix.getAudioContext();
    // const synthPart1 = intermix.getNewPart();
    // const synthPart2 = intermix.getNewPart();
    // const hhatPart = intermix.getNewPart();

    // function init() {

    //     // const testNote = getNote(64, 4, samplerUID);
    //     // samplerActionCreators["NOTE"](testNote);

    //     // make a part and add it to the sequencer
    //     const note1 = getNote(32, 4, synthUID);
    //     const note2 = getNote(33, 4, synthUID);
    //     const note3 = getNote(44, 4, synthUID);
    //     const note4 = getNote(33, 8, synthUID);

    //     console.log(samplerUID);
    //     const hhNote = getNote(40, 8, samplerUID);

    //     synthPart1.addAction(note1, 0)
    //         .addAction(note1, 1)
    //         .addAction(note1, 2)
    //         .addAction(note1, 3)
    //         .addAction(note2, 4)
    //         .addAction(note3, 5)
    //         .addAction(note1, 6)
    //         .addAction(note1, 7)
    //         .addAction(note1, 8)
    //         .addAction(note1, 9)
    //         .addAction(note1, 10)
    //         .addAction(note1, 11)
    //         .addAction(note2, 12)
    //         .addAction(note3, 13)
    //         .addAction(note4, 14);

    //     hhatPart.addAction(hhNote, 0)
    //         .addAction(hhNote, 4)
    //         .addAction(hhNote, 8)
    //         .addAction(hhNote, 12);

    //     seqActionCreators["ADD_PART"]({ part: synthPart1, position: 0 });
    //     seqActionCreators["ADD_PART"]({ part: hhatPart, position: 0 });
    //     seqActionCreators["LOOP_ACTIVE"](true);

    // }


</script>

</html>