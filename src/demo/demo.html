<html>
    <head>
        <title>Sequencer Demo</title>
        <style>
            #blink {
                width: 20px;
                height: 20px;
                border-style: solid;
            }
        </style>
    </head>
    <body onload="init();">
        <button id="resumeAudioContext">resume audio context</button>
        <button id="start">start</button>
        <button id="stop">stop</button>
        <button id="setbpm">set bpm to 180</button>
        <button id="getstate">get current state</button>
        <button id="getPattern">get Pattern</button>
        <div id="blink"></div>
    </body>
    <script>
        const allActionCreators = intermix.getActionCreators();
        let synthUID = "";
        let seqUID = "";
        let seqActionCreators = {};

        const part = intermix.getNewPart();

        function getNote(value, steps, uid) {
            const velocity = 1;
            const duration = 0;
            return {
                type: "NOTE",
                dest: uid,
                payload: {
                    value,
                    velocity,
                    steps,
                    duration,
                }
            }
        }

        function init() {
            for (const uid in allActionCreators) {
                if (allActionCreators[uid].metadata.name === "Intermix Sequencer") {
                    seqUID = uid;
                    seqActionCreators = allActionCreators[uid].actionCreators;
                }
                if (allActionCreators[uid].metadata.name === "Demo Synth") {
                    synthUID = uid;
                }
            }

            // make a part and add it to the sequencer
            const note = {
                value: 64,
                velocity: 1,
                steps: 4,
                duration: 0,
            }
            const noteAction = {
                type: "NOTE",
                dest: synthUID,
                payload: note,
            }
            const attackAction = {
                type: "ENV_ATTACK",
                dest: synthUID,
                payload: { value: 0.3 },
            }

            const note1 = getNote(32, 4, synthUID);
            const note2 = getNote(33, 4, synthUID);
            const note3 = getNote(44, 4, synthUID);
            const note4 = getNote(33, 8, synthUID);

            part.addAction(note1, 0)
                .addAction(note1, 1)
                .addAction(note1, 2)
                .addAction(note1, 3)
                .addAction(note2, 4)
                .addAction(note3, 5)
                .addAction(note1, 6)
                .addAction(note1, 7)
                .addAction(note1, 8)
                .addAction(note1, 9)
                .addAction(note1, 10)
                .addAction(note1, 11)
                .addAction(note2, 12)
                .addAction(note3, 13)
                .addAction(note4, 14)


            seqActionCreators["ADD_PART"]({ part, position: 0 });
            seqActionCreators["LOOP_ACTIVE"](true);

            const animeTest = (step) => {
                let blinker = document.getElementById("blink");
                if (step % 16 === 0) {
                    blinker.style.backgroundColor = "red";
                } else {
                    blinker.style.backgroundColor = "white";
                }
            }
            intermix.animate(animeTest);
        }

        document.getElementById('resumeAudioContext').addEventListener('click', () => {
            intermix.resumeAudioContext();
            console.log("Audio Context Resumed");
        });

        document.getElementById('start').addEventListener('click', () => {
            seqActionCreators["STATE"](1);
        })

        document.getElementById('stop').addEventListener('click', () => {
            seqActionCreators["STATE"](0);
        })

        document.getElementById("getstate").addEventListener('click', () => {
            console.log(intermix.getState());
        })

        document.getElementById("setbpm").addEventListener('click', () => {
            seqActionCreators["BPM"](180);
        })

        document.getElementById("getPattern").addEventListener('click', () => {
            console.log(part.seqPattern);
        })
    </script>
</html>