<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>intermix Demo</title>
    <link rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
    integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
    crossorigin="anonymous"
    >
    <link rel="stylesheet" href="assets/css/bootstrap-slider.css" media="screen" title="no title" charset="utf-8">
    <link rel="stylesheet" href="assets/css/demos.css" media="screen" title="no title" charset="utf-8">
    <script type="text/javascript" src="https://code.createjs.com/preloadjs-0.6.2.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/6.0.5/bootstrap-slider.js"></script>
    <script type="text/javascript" src="../dist/intermix.js"></script>
  </head>
  <body>

    <div class="container row">
      <div class="nav col-md-4">
        <h3>Demos:</h3>
        <ul class="nav nav-pills nav-stacked">
          <li role="presentation"><a href="AudioPlayback.html">Sound</a></li>
          <li role="presentation" class="active"><a href="#">Stepsequencer</a></li>
        </ul>
      </div>
      <div class="demo col-md-8">
        <h1>Stepsequencer</h1>
        <div class="panel panel-primary">
          <div class="panel-heading">
            Plays four audio tracks.
          </div>
          <div class="panel-body">
            <input class="btn btn-default" type="button" value="Start" onclick="start()">
            <input class="btn btn-default" type="button" value="Stop" onclick="stop()">
            BPM: <input id="bpm" type="text" name="name" value="120" onchange="setBpm(this)">
            <br><br>
            <table id="sequencer" class="table-bordered">
              <tr id="seqStepLabel" class="seqRow">
                <td>&nbsp;</td>
                <td id="stepLabel00" class="seqStepLabel">01</td>
                <td id="stepLabel01" class="seqStepLabel">02</td>
                <td id="stepLabel02" class="seqStepLabel">03</td>
                <td id="stepLabel03" class="seqStepLabel">04</td>
                <td id="stepLabel04" class="seqStepLabel">05</td>
                <td id="stepLabel05" class="seqStepLabel">06</td>
                <td id="stepLabel06" class="seqStepLabel">07</td>
                <td id="stepLabel07" class="seqStepLabel">08</td>
                <td id="stepLabel08" class="seqStepLabel">09</td>
                <td id="stepLabel09" class="seqStepLabel">10</td>
                <td id="stepLabel10" class="seqStepLabel">11</td>
                <td id="stepLabel11" class="seqStepLabel">12</td>
                <td id="stepLabel12" class="seqStepLabel">13</td>
                <td id="stepLabel13" class="seqStepLabel">14</td>
                <td id="stepLabel14" class="seqStepLabel">15</td>
                <td id="stepLabel15" class="seqStepLabel">16</td>
              </tr>
              <tr id="bd" class="seqRow">
                <td class="seqStepLabel">Bassdrum</td>
                <td id="bd0" class="seqStep" onclick="changeStep('bd0')"></td>
                <td id="bd1" class="seqStep" onclick="changeStep('bd1')"></td>
                <td id="bd2" class="seqStep" onclick="changeStep('bd2')"></td>
                <td id="bd3" class="seqStep" onclick="changeStep('bd3')"></td>
                <td id="bd4" class="seqStep" onclick="changeStep('bd4')"></td>
                <td id="bd5" class="seqStep" onclick="changeStep('bd5')"></td>
                <td id="bd6" class="seqStep" onclick="changeStep('bd6')"></td>
                <td id="bd7" class="seqStep" onclick="changeStep('bd7')"></td>
                <td id="bd8" class="seqStep" onclick="changeStep('bd8')"></td>
                <td id="bd9" class="seqStep" onclick="changeStep('bd9')"></td>
                <td id="bd10" class="seqStep" onclick="changeStep('bd10')"></td>
                <td id="bd11" class="seqStep" onclick="changeStep('bd11')"></td>
                <td id="bd12" class="seqStep" onclick="changeStep('bd12')"></td>
                <td id="bd13" class="seqStep" onclick="changeStep('bd13')"></td>
                <td id="bd14" class="seqStep" onclick="changeStep('bd14')"></td>
                <td id="bd15" class="seqStep" onclick="changeStep('bd15')"></td>
              </tr>
              <tr id="sd" class="seqRow">
                <td class="seqStepLabel">Snare</td>
                <td id="sd0" class="seqStep" onclick="changeStep('sd0')"></td>
                <td id="sd1" class="seqStep" onclick="changeStep('sd1')"></td>
                <td id="sd2" class="seqStep" onclick="changeStep('sd2')"></td>
                <td id="sd3" class="seqStep" onclick="changeStep('sd3')"></td>
                <td id="sd4" class="seqStep" onclick="changeStep('sd4')"></td>
                <td id="sd5" class="seqStep" onclick="changeStep('sd5')"></td>
                <td id="sd6" class="seqStep" onclick="changeStep('sd6')"></td>
                <td id="sd7" class="seqStep" onclick="changeStep('sd7')"></td>
                <td id="sd8" class="seqStep" onclick="changeStep('sd8')"></td>
                <td id="sd9" class="seqStep" onclick="changeStep('sd9')"></td>
                <td id="sd10" class="seqStep" onclick="changeStep('sd10')"></td>
                <td id="sd11" class="seqStep" onclick="changeStep('sd11')"></td>
                <td id="sd12" class="seqStep" onclick="changeStep('sd12')"></td>
                <td id="sd13" class="seqStep" onclick="changeStep('sd13')"></td>
                <td id="sd14" class="seqStep" onclick="changeStep('sd14')"></td>
                <td id="sd15" class="seqStep" onclick="changeStep('sd15')"></td>
              </tr>
              <tr id="hh" class="seqRow">
                <td class="seqStepLabel">Hihat</td>
                <td id="hh0" class="seqStep" onclick="changeStep('hh0')"></td>
                <td id="hh1" class="seqStep" onclick="changeStep('hh1')"></td>
                <td id="hh2" class="seqStep" onclick="changeStep('hh2')"></td>
                <td id="hh3" class="seqStep" onclick="changeStep('hh3')"></td>
                <td id="hh4" class="seqStep" onclick="changeStep('hh4')"></td>
                <td id="hh5" class="seqStep" onclick="changeStep('hh5')"></td>
                <td id="hh6" class="seqStep" onclick="changeStep('hh6')"></td>
                <td id="hh7" class="seqStep" onclick="changeStep('hh7')"></td>
                <td id="hh8" class="seqStep" onclick="changeStep('hh8')"></td>
                <td id="hh9" class="seqStep" onclick="changeStep('hh9')"></td>
                <td id="hh10" class="seqStep" onclick="changeStep('hh10')"></td>
                <td id="hh11" class="seqStep" onclick="changeStep('hh11')"></td>
                <td id="hh12" class="seqStep" onclick="changeStep('hh12')"></td>
                <td id="hh13" class="seqStep" onclick="changeStep('hh13')"></td>
                <td id="hh14" class="seqStep" onclick="changeStep('hh14')"></td>
                <td id="hh15" class="seqStep" onclick="changeStep('hh15')"></td>
              </tr>
              <tr id="bass" class="seqRow">
                <td class="seqStepLabel">Bass</td>
                <td id="bass0" class="seqStep" onclick="changeStep('bass0')"></td>
                <td id="bass1" class="seqStep" onclick="changeStep('bass1')"></td>
                <td id="bass2" class="seqStep" onclick="changeStep('bass2')"></td>
                <td id="bass3" class="seqStep" onclick="changeStep('bass3')"></td>
                <td id="bass4" class="seqStep" onclick="changeStep('bass4')"></td>
                <td id="bass5" class="seqStep" onclick="changeStep('bass5')"></td>
                <td id="bass6" class="seqStep" onclick="changeStep('bass6')"></td>
                <td id="bass7" class="seqStep" onclick="changeStep('bass7')"></td>
                <td id="bass8" class="seqStep" onclick="changeStep('bass8')"></td>
                <td id="bass9" class="seqStep" onclick="changeStep('bass9')"></td>
                <td id="bass10" class="seqStep" onclick="changeStep('bass10')"></td>
                <td id="bass11" class="seqStep" onclick="changeStep('bass11')"></td>
                <td id="bass12" class="seqStep" onclick="changeStep('bass12')"></td>
                <td id="bass13" class="seqStep" onclick="changeStep('bass13')"></td>
                <td id="bass14" class="seqStep" onclick="changeStep('bass14')"></td>
                <td id="bass15" class="seqStep" onclick="changeStep('bass15')"></td>
              </tr>
            </table>
          </div>
          <div class="panel-footer">
            Drumsounds sampled from a <a href="http://www.vintagesynth.com/casio/sk1.php">Casio SK-1</a>.
          </div>
        </div>

      </div>
    </div>

    <script type="text/javascript">

      var bdSound, sdSound, hhSound, bassSound;
      var bdPart, sdPart, hhPart;
      var bdNote, sdNote, hhNote;
      var queue = new createjs.LoadQueue();
      var binaryKick;

      var seq = new intermix.Sequencer();
      seq.loop = true;
      seq.loopStart = 0;
      seq.loopEnd = 63;   //this should be set in resolution steps (15 with 16th notes)

      function initParts() {
        bdPart = new intermix.Part();
        sdPart = new intermix.Part();
        hhPart = new intermix.Part();

        // create note events for the drumset
        bdNote = intermix.events.createAudioNote('a3', 1, 0, bdSound);
        sdNote = intermix.events.createAudioNote('a3', 1, 0, sdSound);
        hhNote = intermix.events.createAudioNote('a3', 1, 0, hhSound);

        bdPart.addEvent(bdNote, 0);
        bdPart.addEvent(bdNote, 8);
        sdPart.addEvent(sdNote, 4);
        sdPart.addEvent(sdNote, 12);

        for (i = 0; i < 16; i++) {
          hhPart.addEvent(hhNote, i);
        }

        seq.addPart(bdPart, 0);
        seq.addPart(sdPart, 0);
        seq.addPart(hhPart, 0);
      };

      function start() {
        seq.start();
      };

      function stop() {
        seq.stop();
      };

      function setBpm(bpm) {
        seq.setBpm(bpm.value);
      };

      function drawActiveSteps() {
        bdSteps = bdPart.getNotePositions();
        sdSteps = sdPart.getNotePositions();
        hhSteps = hhPart.getNotePositions();

        bdSteps.forEach(function(pos) {
          document.getElementById('bd' + pos).style.backgroundColor = 'red';
        });
        sdSteps.forEach(function(pos) {
          document.getElementById('sd' + pos).style.backgroundColor = 'red';
        });
        hhSteps.forEach(function(pos) {
          document.getElementById('hh' + pos).style.backgroundColor = 'red';
        });
      };

      function changeStep(elId, part) {
        var el = document.getElementById(elId);
        var pos = elId.match(/\d+/)[0];
        var prefix = elId.replace(/\d+/g,'');
        console.log('pos: ' + pos + ', prefix: ' + prefix);
        console.log(el.style.backgroundColor);
        if (el.style.backgroundColor === 'red') {
          el.style.backgroundColor = 'white';
          if (prefix === 'bd') {
            bdPart.removeEvent(bdNote, pos);
          } else if (prefix === 'sd') {
            sdPart.removeEvent(sdNote, pos);
          } else if (prefix === 'hh') {
            hhPart.removeEvent(hhNote, pos);
          }
        } else {
          el.style.backgroundColor = 'red';
          if (prefix === 'bd') {
            bdPart.addEvent(bdNote, pos);
          } else if (prefix === 'sd') {
            sdPart.addEvent(sdNote, pos);
          } else if (prefix === 'hh') {
            hhPart.addEvent(hhNote, pos);
          }
        }

        // var newColor = (el.style.backgroundColor === 'white' ||
        //   el.style.backgroundColor === '') ? 'red' : 'white';
        // el.style.backgroundColor = newColor;
      };



        // var bgColor = '#f0f0f0';
        // for (var i = 0; i < 16; i++) {
        //   var bdStep = document.getElementById('bd' + i);
        //   bdStep.style.backgroundColor = bgColor;
        //
        //   if (i > 0) {
        //     var bdStepPre = document.getElementById('bd' + (i - 1));
        //     bdStepPre.style.backgroundColor = 'white';
        //   } else {
        //     var bdStepPre = document.getElementById('bd15');
        //     bdStepPre.style.backgroundColor = 'white';
        //   }
          // setTimeout(function() {
          //   console.log(i);
          //   var bdStep = document.getElementById('bd' + i);
          //   bdStep.style.backgroundColor = bgColor;
          //   if (i > 0) {
          //     //document.getElementById('bd' + (i-1)).style.background-color = 'white';
          //   }
          // }, 500);
        // }
      //}

      // function set16thNote(beats) {
      //   sixteenthNote = 60 / (beats * 16);
      // }

      function handleComplete() {
        var bdRaw = queue.getResult('kick');
        var sdRaw = queue.getResult('snare');
        var hhRaw = queue.getResult('hihat');
        var bassRaw = queue.getResult('bass');
        var bdBuffer = new intermix.SoundWave(bdRaw);
        var sdBuffer = new intermix.SoundWave(sdRaw);
        var hhBuffer = new intermix.SoundWave(hhRaw);
        var bassBuffer = new intermix.SoundWave(bassRaw);
        setTimeout(function() {
          bdSound = new intermix.Sound(bdBuffer);
          sdSound = new intermix.Sound(sdBuffer);
          hhSound = new intermix.Sound(hhBuffer);
          bassSound = new intermix.Sound(bassBuffer);
        }, 500);

        setTimeout(function() {
          initParts();
          drawActiveSteps();
        }, 600);
      }

      (function() {
        queue.on('complete', handleComplete, this);
        queue.loadManifest([
          {id: 'kick', src:'assets/samples/Casio\ SK-1/skkick.wav', type:createjs.AbstractLoader.BINARY},
          {id: 'snare', src:'assets/samples/Casio\ SK-1/sksnare.wav', type:createjs.AbstractLoader.BINARY},
          {id: 'hihat', src:'assets/samples/Casio\ SK-1/skclhat.wav', type:createjs.AbstractLoader.BINARY},
          {id: 'bass', src:'assets/samples/JX3-BS05.WAV', type:createjs.AbstractLoader.BINARY},
        ]);

      })();
    </script>
  </body>
</html>
